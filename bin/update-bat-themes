#!/usr/bin/env zsh
# Bat theme auto-updater with interactive yadm commit

set -euo pipefail

xdg_config_dir="${XDG_CONFIG_HOME:-"${HOME}/.config"}"
bat_config_dir="${BAT_CONFIG_DIR:-"${xdg_config_dir}/bat"}"
bat_themes_dir="${bat_config_dir}/themes"

[[ -d "${bat_themes_dir}" ]] || mkdir -p "${bat_themes_dir}"

typeset -a updated_files=()

sync() {
  print -u2 "* ${1}\n  â†ª ${2}"

  if curl --fail -slo "${2}" "${1}"; then
    if (( ${+commands[yadm]} )) && [[ -n "$(yadm status --porcelain "${2}")" ]]; then
      updated_files+=("${2}")
    fi
  fi
}

update_bat_theme() {
  local src="$1"
  local dst="${bat_themes_dir}/${2:-"$(basename "$src")"}"

  sync "${src}" "${dst}"
}

update_bat_theme "https://raw.githubusercontent.com/folke/tokyonight.nvim/main/extras/sublime/tokyonight_day.tmTheme"
update_bat_theme "https://raw.githubusercontent.com/folke/tokyonight.nvim/main/extras/sublime/tokyonight_storm.tmTheme"
update_bat_theme "https://raw.githubusercontent.com/folke/tokyonight.nvim/main/extras/sublime/tokyonight_moon.tmTheme"
update_bat_theme "https://raw.githubusercontent.com/folke/tokyonight.nvim/main/extras/sublime/tokyonight_night.tmTheme"
update_bat_theme "https://raw.githubusercontent.com/scottmckendry/cyberdream.nvim/refs/heads/main/extras/textmate/cyberdream.tmTheme"
update_bat_theme "https://raw.githubusercontent.com/scottmckendry/cyberdream.nvim/refs/heads/main/extras/textmate/cyberdream-light.tmTheme"

if (( ${+commands[bat]} )); then
  bat cache --build
fi

if (( ${+commands[yadm]} && ${#updated_files[@]} )); then
  yadm add "${updated_files[@]}"

  print -u2 "\nDo you want to commit the following updated Bat themes to yadm?"

  for f in "${updated_files[@]}"; do
    print -u2 "  ${f}"
  done

  print -u2 -n "> Commit these files? (y/N): "
  read -r reply

  if [[ "$reply" =~ ^[Yy] ]]; then
    yadm commit "${updated_files[@]}" -m "chore(bat): Update themes"
  else
    print -u2 "Skipped yadm commit."
  fi
fi

unset xdg_config_dir bat_config_dir bat_themes_dir
unset updated_file sync update_bat_theme
