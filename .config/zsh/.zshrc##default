# vim: ft=zsh

typeset -r plugins="${ZDOTDIR}/plugins"

# A command-line fuzzy finder
# https://github.com/junegunn/fzf
typeset -i has_fzf=$(( ${+commands[fzf]} ))

# A smarter cd command.
# https://github.com/ajeetdsouza/zoxide
typeset -i has_zoxide=$(( ${+commands[zoxide]} ))

# ZSH Options -- https://zsh.sourceforge.io/Doc/Release/Options.html
################################################################################

# Core interaction options
setopt autocd              # Change directories just by typing their names.
setopt autopushd           # Keep a directory stack when using cd.
setopt pushdignoredups     # Avoid duplicates in directory stack.
setopt nobeep              # Disable annoying terminal beep.
setopt interactivecomments # Allow comments in interactive mode.
setopt correct             # Try to correct the spelling of commands.
setopt nocorrectall        # But don't correct arguments.

# Auto-completion
setopt completeinword      # Complete from both ends of a word.
setopt alwaystoend         # Move cursor to the end of a completed word.
setopt pathdirs            # Perform path search even on command names with slashes.
setopt automenu            # Show completion menu on a successive tab press.
setopt autolist            # Automatically list choices on ambiguous completion.
setopt autoparamslash      # If completed parameter is a directory, add a trailing slash.
unsetopt menucomplete      # Do not autoselect the first completion entry.
unsetopt flowcontrol       # Disable start/stop characters in shell editor.

# Filename and globbing behavior
setopt extendedglob        # Enable advanced globbing (e.g., ^, ~, and ** wildcards).
setopt nocaseglob          # Make filename completion case-insensitive.
setopt nomatch             # Print an error when glob patterns don't match.
setopt globdots            # Include dotfiles in globbing patterns.

# Command history
setopt extendedhistory     # Record timestamps in history.
setopt histignoredups      # Donâ€™t record duplicate commands.
setopt histignorespace     # Ignore commands prefixed with a space.
setopt histreduceblanks    # Remove redundant empty lines from history.
setopt incappendhistory    # Append to history file incrementally (no loss on crash).
setopt sharehistory        # Share history across multiple Zsh sessions.

# Safety and strictness
setopt noclobber           # Prevent overwriting files with > redirection.
setopt noglobdots          # (optional) Hide dotfiles unless you explicitly include them.
setopt localoptions        # Make option changes local to functions.
setopt localtraps          # Make traps local to functions.

# Usability enhancements
setopt promptsubst         # Allow variable expansion in prompts.
setopt nohup               # Prevent background jobs from hanging up on logout.
setopt notify              # Report job status changes immediately.

# ENV meaningful in interactive shells only
################################################################################

# The next gen ls command
# https://github.com/lsd-rs/lsd
if (( ${+commands[lsd]} )); then
  alias ll='lsd --all -l'
  alias la='lsd --almost-all'
# A themeable LS_COLORS generator with a rich filetype datebase.
# https://github.com/sharkdp/vivid/
elif (( ${+commands[vivid]} )); then
  typeset -gx LS_COLORS="$(vivid generate gruvbox-dark-hard)"

  alias ls='ls --color=auto'
  alias ll='ls --color=auto --all --long'
  alias la='ls --color=auto --almost-all'
fi

# Plugins
################################################################################

source "${plugins}/colors/colors.plugin.zsh"
source "${plugins}/zsh-history-substring-search/zsh-history-substring-search.zsh"

# Aliases
################################################################################

# Git
alias gbv="git branch --verbose --verbose"
alias gfp="git fetch --prune"
alias gri="git rebase --interactive"

# Ruby
alias be="bundle exec"
alias bi="bundle install"
alias bu="bundle update"
alias bo="bundle open"
alias ror="bundle exec rails"

# Other tools
alias om="overmind"
alias av="aws-vault"
alias ave="aws-vault exec"

# Integrations
################################################################################

# The minimal, blazing-fast, and infinitely customizable prompt.
# https://starship.rs/
if (( ${+commands[starship]} )); then
  # See: https://github.com/starship/starship/issues/2637
  # source <(command starship init zsh --print-full-init)
  source <(command starship init zsh)
fi

if (( has_fzf )); then
  source <(command fzf --zsh)
fi

# NOTE: Must be last thing in the config, if used with `--cmd cd`
if (( has_zoxide )); then
  source <(command zoxide init zsh)
fi

# Custom functions
################################################################################

autoload -Uz gh-access-token
autoload -Uz zz

# Local overrides
################################################################################

local zshrc_local="${ZDOTDIR}/local/.zshrc"
[[ -f "$zshrc_local" ]] && source "$zshrc_local" || true
unset zshrc_local

# Setup Auto-Completion
################################################################################

# Deduplicate path and fpath again before initializing completions
typeset -gU path fpath

autoload -Uz compinit

typeset zcompdump_path="${XDG_CACHE_HOME}/zsh/zcompdump"
if [[ $zcompdump_path(#qNmh-20) ]]; then
  # -C (skip function check) implies -i (skip security check).
  compinit -C -d "$zcompdump_path"
else
  mkdir -p "$zcompdump_path:h"
  compinit -i -d "$zcompdump_path"
  # Keep $zcompdump_path younger than cache time even if it isn't regenerated.
  touch "$zcompdump_path"
fi
unset zcompdump_path

################################################################################

# Note that zsh-syntax-highlighting must be the last plugin sourced.
# See: <https://github.com/zsh-users/zsh-syntax-highlighting/blob/master/INSTALL.md#with-a-plugin-manager>
source "${plugins}/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh"
